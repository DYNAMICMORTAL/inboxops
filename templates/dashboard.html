{% extends "layout.html" %} 

{% block title %}
Dashboard - InboxOps
{% endblock %}

{% block content %}
<link rel="stylesheet" href="../static/styles.css">

<section style="margin-bottom: 0;" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
    <div class="card bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm">
    <h3 class="text-lg font-semibold text-blue-600">Total Processed</h3>
    <p class="text-3xl font-bold text-blue-800">{{ total_processed }}</p>
    <p class="text-sm text-blue-500">+{{ processed_today }} today</p>
    <div class="mt-2">
      <p class="text-xs text-blue-400">Processed Emails: {{ total_processed }}%</p>
      <div class="w-full bg-blue-200 rounded-full h-2.5">
        <div class="bg-blue-600 h-2.5 rounded-full" data-processing-rate="{{ processing_rate|default(0) }}"></div>
      </div>
    </div>
    </div>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-green-600">Success Rate</h3>
      <p class="text-3xl font-bold text-green-800">{{ success_rate }}%</p>
      <p class="text-sm text-green-500">↑ {{ success_rate_change }}% from last week</p>
      <p class="text-xs text-green-400">Avg. Processing Time: {{ avg_processing_time }}s</p>
    </div>

    <div class="card bg-orange-50 border border-orange-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-orange-600">Active Webhooks</h3>
      <p class="text-3xl font-bold text-orange-800">{{ active_webhooks }}</p>
      <p class="text-sm text-orange-500">{{ webhook_endpoints }} endpoints configured</p>
      <p class="text-xs text-orange-400">Avg. Latency: {{ avg_latency }}ms</p>
    </div>

    <div class="card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-purple-600">Pending Approvals</h3>
      <p class="text-3xl font-bold text-purple-800">{{ approvals|length }}</p>
      <p class="text-sm text-purple-500">Last Approval: {{ approvals[0].created_at.strftime('%b %d, %I:%M %p') if approvals }}</p>
    </div>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-green-600">Orders</h3>
      <p class="text-3xl font-bold text-green-800">{{ orders|length }}</p>
      <p class="text-sm text-green-500">Last Order: {{ orders[0].created_at.strftime('%b %d, %I:%M %p') if orders }}</p>
    </div>

    <div class="card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-purple-600">Classifications</h3>
      <p class="text-3xl font-bold text-purple-800">{{ active_models }}</p>
      <p class="text-sm text-purple-500">Top Type: {{ top_classification_type }} ({{ top_classification_percentage }}%)</p>
    </div>
    <div class="card bg-red-50 border border-red-200 rounded-lg p-4 shadow-sm">
      <h3 class="text-lg font-semibold text-red-600">Error Rate</h3>
      <p class="text-3xl font-bold text-red-800">{{ error_rate }}%</p>
      <p class="text-sm text-red-500">↓ {{ error_rate_change }}% from yesterday</p>
      <p class="text-xs text-red-400">Last Error: {{ last_error_time }}</p>
    </div>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm relative">
      <h3 class="text-lg font-semibold text-green-600">DKIM Signature</h3>
      <p class="text-3xl font-bold text-green-800">Valid</p>
      <p class="text-sm text-green-500">All emails are signed</p>
      <button class="text-sm text-blue-500 underline mt-2" onclick="showDkimInfo()">What is DKIM?</button>
      <div id="dkim-info-popup" class="hidden absolute top-12 left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-4 w-64 z-10">
      <p class="text-sm text-gray-700">DKIM (DomainKeys Identified Mail) is an email authentication method that uses public-key cryptography to sign emails and verify that the message body and attachments were not altered in transit.</p>
      <button class="text-xs text-blue-500 underline mt-2" onclick="hideDkimInfo()">Close</button>
      </div>
    </div>

    <script>
      function showDkimInfo() {
      document.getElementById('dkim-info-popup').classList.remove('hidden');
      }

      function hideDkimInfo() {
      document.getElementById('dkim-info-popup').classList.add('hidden');
      }
    </script>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm relative">
      <h3 class="text-lg font-semibold text-green-600">SPF Policy</h3>
      <p class="text-3xl font-bold text-green-800">Valid</p>
      <p class="text-sm text-green-500">SPF checks passed</p>
      <button class="text-sm text-blue-500 underline mt-2" onclick="showSpfInfo()">What is SPF?</button>
      <div id="spf-info-popup" class="hidden absolute top-12 left-0 bg-white border border-gray-300 rounded-lg shadow-lg p-4 w-64 z-10">
        <p class="text-sm text-gray-700">
          SPF (Sender Policy Framework) is an email authentication standard that helps detect forged sender addresses, protecting both senders and recipients from spam, spoofing, and phishing attempts.
        </p>
        <p class="text-sm text-gray-700 mt-2">
          PS: Postmark blocks spam inbound mails by parsing JSON.
        </p>
        <button class="text-xs text-blue-500 underline mt-2" onclick="hideSpfInfo()">Close</button>
      </div>
    </div>

    <script>
      function showSpfInfo() {
        document.getElementById('spf-info-popup').classList.remove('hidden');
      }

      function hideSpfInfo() {
        document.getElementById('spf-info-popup').classList.add('hidden');
      }
    </script>
</section>

<section class="bg-gray-100 shadow-md rounded-lg p-6 mb-6">
    <nav class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
        <a href="#" id="active-workflows-tab" class="nav-card bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-blue-100 active:bg-blue-200">
            <h3 class="text-lg font-semibold text-blue-600">Active Workflows</h3>
            <p class="text-sm text-gray-500">View all workflows</p>
        </a>
        <a href="#" id="sales-tab" class="nav-card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-green-100 active:bg-green-200">
            <h3 class="text-lg font-semibold text-green-600">Sales</h3>
            <p class="text-sm text-gray-500">View orders</p>
        </a>
        <a href="#" id="hr-workflows-tab" class="nav-card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-purple-100 active:bg-purple-200">
            <h3 class="text-lg font-semibold text-purple-600">HR Workflows</h3>
            <p class="text-sm text-gray-500">View approvals</p>
        </a>
        <a href="#" id="approvals-tab" class="nav-card bg-orange-50 border border-orange-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-orange-100 active:bg-orange-200">
            <h3 class="text-lg font-semibold text-orange-600">Pending Approvals</h3>
            <p class="text-sm text-gray-500">View pending tasks</p>
        </a>
        <a href="#" id="customer-enquiries-tab" class="nav-card bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-gray-100 active:bg-gray-200">
            <h3 class="text-lg font-semibold text-gray-600">Customer Enquiries</h3>
            <p class="text-sm text-gray-500">View Tickets</p>
        </a>
    </nav>
</section>

<section class="mb-8 orderCard">
    <h2 class="text-xl font-semibold mb-3">Orders</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for order in orders %}
        <a href="#" class="order-card border rounded-lg p-4 shadow-sm bg-white transform transition-transform duration-200 hover:scale-105" data-order-id="{{ order.id }}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M9 21V3m0 0L3 10m6-7l6 7" />
                    </svg>
                    <span class="font-black text-gray-700">#{{ order.id }}</span>
                    <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-0.5 font-black rounded">Key: {{ order.key }}</span>
                </div>
                <span class="badge badge-confirmed">Confirmed</span>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-500">Customer</p>
                <p class="font-semibold text-lg text-gray-800">
                    {% for email in emails %}
                        {% if email.type == 'ORDER' and email.key == order.key %}
                            {{ email.from_email }}
                        {% endif %}
                    {% endfor %}
                </p>
            </div>

            <div class="mb-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Quantity</p>
                    <p class="font-semibold text-xl text-gray-800">{{ order.quantity }}</p>
                </div>

                <div>
                    <p class="text-sm text-gray-500">Total Value</p>
                    <p class="font-semibold text-green-600">USD {{ order.total_value }}</p>
                </div>
            </div>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg shadow-sm">
                <h3 class="text-sm font-semibold text-blue-600 mb-1">AI Summary</h3>
                <p class="text-sm text-gray-700">{{ order.summary }}</p>
            </div>

            <!-- ...existing code... -->
            <div class="mb-4">
              <p class="text-sm text-gray-500">Automation Progress</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-600 h-2.5 rounded-full"
                     style="width: '{{ order.automation_percent|default(0)|int }}%';">
                </div>
              </div>
              <div class="flex justify-between mt-1 text-xs text-gray-500">
                <span>{{ order.automation_completed if order.automation_completed is defined else 0 }}/3 steps</span>
                <span>%</span>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm text-gray-500">
              <div style="width: 35vw;" class="flex items-center gap-2">
                <svg class="calender" width="5%" height="5%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 10H3M16 2V6M8 2V6M7.8 22H16.2C17.8802 22 18.7202 22 19.362 21.673C19.9265 21.3854 20.3854 20.9265 20.673 20.362C21 19.7202 21 18.8802 21 17.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V17.2C3 18.8802 3 19.7202 3.32698 20.362C3.6146 20.9265 4.07354 21.3854 4.63803 21.673C5.27976 22 6.11984 22 7.8 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="font-black datetime">
                        {{ order.created_at.strftime('%b %d, %I:%M %p') if order.created_at }}
                    </span>
                </div>
                <div class="flex gap-2">
                    {% for tag in order.tags or [] %}
                    <span class="badge badge-tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="order-items" style="display:none;">{{ order.order_items | tojson | safe }}</div>
            <div class="mail-content" style="display:none;">{{ order.mail_content|safe }}</div>
            <div class="raw-json" style="display:none;">{{ order.raw_json | tojson | safe }}</div>
        </a>
        {% endfor %}
    </div>
</section>

<div id="order-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl max-h-[89vh] h-auto p-6" style="height:auto;max-height:89vh;">
        <div class="flex justify-between items-center mb-4">
            <h2 id="order-title" class="text-2xl font-bold text-gray-800">Order Details</h2>
            {% for order in orders %}
            <span class="ml-2 text-sm text-gray-500 bg-gray-100 px-2 py-0.5 font-black rounded">{{ order.key }}</span>
            <!-- {% endfor %} -->
            <button id="close-modal" class="text-gray-500 hover:text-gray-800 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="order-content" class="space-y-6 text-sm text-gray-700 overflow-y-auto" style="max-height:70vh;">
  <div class="flex justify-between items-center">
    <span class="text-lg font-semibold text-gray-800">Order #<span id="order-id">TC-XXXX-001</span></span>
    <div class="flex flex-col items-end text-xs text-right">
      <span class="inline-block bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">CONFIRMED</span>
      <span class="mt-1 text-gray-500">Mon, Jan 15, 2024, 08:00 PM</span>
      <span class="text-gray-400 text-xs">Updated Mon, Jan 15, 2024, 08:45 PM</span>
    </div>
  </div>

  <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Customer Information -->
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">👤 Customer Information</h3>
      <p><strong>Name:</strong> <span id="customer-name" class="text-gray-800"></span></p>
      <p><strong>Company:</strong> TechCorp Solutions</p>
      <p><strong>Email:</strong> <span id="customer-email" class="text-gray-800"></span></p>
      <p><strong>Customer Type:</strong> <span class="bg-gray-200 text-xs px-2 py-0.5 rounded-full">existing</span></p>
    </div>

    <!-- Tags & Classification -->
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">🏷️ Tags & Classification</h3>
      <div class="flex flex-wrap gap-2">
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">enterprise</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">high-value</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">existing-customer</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">express-shipping</span>
      </div>
    </div>
  </div>

  <!-- Order Summary -->
  <div class="border-t pt-4">
    <h3 class="font-semibold text-gray-800 text-base mb-2">💲 Order Summary</h3>
    <p class="text-xl text-gray-900 font-bold mb-2">USD <span id="order-value"></span></p>
    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">3 items</span>
    <div class="mt-3 bg-blue-50 p-3 rounded-md">
      <h4 class="font-medium text-blue-800 mb-1">AI Summary</h4>
      <p id="order-summary" class="text-sm text-blue-900"></p>
    </div>
  </div>

  <!-- Metrics -->
  <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">📈 Metrics</h3>
      <p><strong>Processing Time:</strong> 2.5 hours</p>
      <p><strong>Priority:</strong> low</p>
    </div>
  </div>
</div>

    </div>
</div>
<section class="approvalCard">
    <h2 class="font-semibold mb-3">HR Workflows</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for approval in approvals %}
                <a href="#" class="approval-card border rounded-lg p-4 shadow-sm bg-white transform transition-transform duration-200 hover:scale-105"
           data-id="{{ approval.id }}"
           data-sender="{{ approval.sender }}"
           data-type="{{ approval.approval_type }}"
           data-summary="{{ approval.summary or '' }}"
           data-status="{{ approval.status }}"
           data-created="{{ approval.created_at }}"
           data-request="{{ approval.request_text }}"
           data-start="{{ approval.start_date }}"
           data-end="{{ approval.end_date }}"
           data-tags="{{ approval.tags|join(',') if approval.tags else '' }}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M9 21V3m0 0L3 10m6-7l6 7" />
                    </svg>
                    <span class="font-black text-gray-700">{{ approval.approval_type }}</span>
                </div>
                <span class="badge badge-under-review">{{ approval.status }}</span>
            </div>
        
            <div class="mb-4">
                <p class="text-sm text-gray-500">Employee</p>
                <p class="font-semibold text-lg text-gray-800">{{ approval.sender }}</p>
            </div>
        
            <div class="mb-4">
                <p class="text-sm text-gray-500">Request Type</p>
                <p class="font-semibold text-lg text-gray-800">{{ approval.approval_type }}</p>
            </div>
        
            <div class="mb-4 p-4 bg-purple-50 rounded-lg shadow-sm">
                <h3 class="text-sm font-semibold text-purple-600 mb-1">Summary</h3>
                <p class="text-sm text-gray-700">
                    {% if approval.summary %}
                        {{ approval.summary }}
                    {% else %}
                        <span class="badge badge-warning">Processing...</span>
                    {% endif %}
                </p>
            </div>
        
            <div class="mb-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Start</p>
                    <p class="font-semibold text-lg text-gray-800">
                        {{ approval.start_date.strftime('%Y-%m-%d') if approval.start_date }}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">End</p>
                    <p class="font-semibold text-lg text-gray-800">
                        {{ approval.end_date.strftime('%Y-%m-%d') if approval.end_date }}
                    </p>
                </div>
            </div>
        
            <div class="flex items-center justify-between text-sm text-gray-500">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 4h10M5 21h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="font-black">
                        SLA: {{ approval.created_at.strftime('%b %d, %I:%M %p') }}
                    </span>
                </div>
                <div class="flex gap-2">
                    <span class="badge badge-tag">{{ approval.approval_type }}</span>
                    <span class="badge badge-tag">HR</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</section>
<!-- Approval Modal -->
<div id="approval-modal" style="z-index: 1000;" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div style="height:auto;max-height:89vh;" class="bg-white rounded-lg shadow-lg w-full max-w-6xl max-h-[89vh] h-auto p-6 relative overflow-y-auto">
    <div class="flex justify-between items-center px-2 py-2 border-b">
      <h2 id="approval-modal-title" class="text-2xl font-bold text-gray-900">Approval Request</h2>
      <button id="closeApprovalModal" class="text-gray-500 hover:text-gray-800 transition duration-200 text-2xl">&times;</button>
    </div>
    <div class="flex border-b px-2">
      <button onclick="switchApprovalTab('overview')" id="approval-tab-overview" class="tab-btn px-6 py-3 font-semibold text-sm text-black border-b-2 border-black">Overview</button>
      <button onclick="switchApprovalTab('details')" id="approval-tab-details" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 border-b-2 border-transparent">Details</button>
      <button onclick="switchApprovalTab('timeline')" id="approval-tab-timeline" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 border-b-2 border-transparent">Timeline</button>
      <button onclick="switchApprovalTab('actions')" id="approval-tab-actions" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 border-b-2 border-transparent">Actions</button>
    </div>
    <div id="approval-tab-content" class="p-2 text-sm text-gray-700 space-y-6 overflow-y-auto" style="max-height:60vh;">
      <!-- Dynamic content will be injected here -->
    </div>
  </div>
</div>

<section class="mb-8 mt-3 customerEnquiryCard">
    <h2 class="text-xl font-semibold mb-3">Customer Enquiries Support Issues Tickets</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for ticket in support_tickets %}
        <a href="#"
           class="customer-enquiry-card border rounded-lg p-4 shadow-sm bg-white transform transition-transform duration-200 hover:scale-105"
           data-id="{{ ticket.id }}"
           data-subject="{{ ticket.subject }}"
           data-sender="{{ ticket.sender }}"
           data-category="{{ ticket.category }}"
           data-status="{{ ticket.status }}"
           data-message="{{ ticket.message|e }}"
           data-summary="{{ ticket.summary }}"
           data-tags="{{ ticket.tags }}"
           data-created="{{ ticket.created_at.strftime('%b %d, %I:%M %p') }}"
           data-email="{{ ticket.email if ticket.email else '' }}"
           data-estimated-value="{{ ticket.estimated_value or '' }}"
           data-criticality="{{ ticket.criticality }}"
           data-assigned="{{ ticket.assigned_to or '' }}"
           data-rawjson="{{ ticket.raw_json | tojson | safe if ticket.raw_json else '' }}"
        >
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 4h10M5 21h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="font-black text-gray-700">{{ ticket.subject }}</span>
                </div>
                <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-3 py-1 rounded-full">{{ ticket.status|capitalize }}</span>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-500">Category</p>
                <p class="font-semibold text-lg text-gray-800">{{ ticket.category or "General" }}</p>
            </div>
            <div class="mb-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Inquirer</p>
                    <p class="font-semibold text-lg text-gray-800">{{ ticket.sender }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Type</p>
                    <span class="bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ ticket.category or "enquiry" }}</span>
                </div>
            </div>
            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-1">Description:</p>
                <p class="text-gray-800 text-sm">{{ ticket.summary }}</p>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mt-2 gap-2">
                <div class="flex items-center gap-2 text-xs text-gray-500 mb-2 sm:mb-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 4h10M5 21h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <span class="text-sm font-black">Response: 2 hours</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    {% for tag in (ticket.tags.split(',') if ticket.tags else []) %}
                    <span class="bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded-full mb-1">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
        </a>
      {% endfor %}
    </div>
</section>

<!-- Customer Enquiry Modal -->
<div id="customerEnquiryModal" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[89vh] h-auto p-6 relative overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 id="enquiry-modal-title" class="text-2xl font-bold text-gray-800">Customer Enquiry Details</h2>
      <button id="closeCustomerEnquiryModal" class="text-gray-500 hover:text-gray-800 transition duration-200 text-2xl">&times;</button>
    </div>
    <div class="flex border-b mb-4">
      <button onclick="switchEnquiryTab('overview')" id="enquiry-tab-overview" class="tab-btn px-6 py-3 font-semibold text-sm text-black border-b-2 border-black">Overview</button>
      <button onclick="switchEnquiryTab('details')" id="enquiry-tab-details" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500">Details</button>
      <button onclick="switchEnquiryTab('timeline')" id="enquiry-tab-timeline" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500">Timeline</button>
      <button onclick="switchEnquiryTab('actions')" id="enquiry-tab-actions" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500">Email</button>
    </div>
    <div id="enquiry-tab-content" class="p-4 text-sm text-gray-700 space-y-6 overflow-y-auto" style="max-height:60vh;">
      <!-- Overview -->
      <div id="enquiry-content-overview">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Inquirer Information -->
          <div class="col-span-2 bg-white rounded-xl border p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="inline-block">👤</span> Inquirer Information
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-gray-500 text-sm mb-1">Name</div>
                <div class="font-bold text-lg text-gray-900" id="modalEnquirySender"></div>
                <div class="text-gray-500 text-sm mt-4 mb-1">Email</div>
                <div class="text-gray-700 text-sm" id="modalEnquiryEmail">{{support_tickets.sender}}</div>
              </div>
              <div>
                <div class="text-gray-500 text-sm mb-1">Company</div>
                <div class="font-bold text-lg text-gray-900" id="N/A"></div>
                <div class="text-gray-500 text-sm mt-4 mb-1">Source</div>
                <span id="modalEnquirySource" class="bg-gray-100 text-xs px-2 py-1 rounded-full">email</span>
              </div>
            </div>
            <div class="mt-4 flex gap-6">
              <div>
                <div class="text-gray-500 text-sm mb-1">Response Time</div>
                <span id="modalEnquiryResponseTime" class="text-green-600 font-bold">2 hours</span>
              </div>
              <div>
                <div class="text-gray-500 text-sm mb-1">Status</div>
                <span id="modalEnquiryStatus" class="bg-purple-100 text-purple-700 text-xs font-semibold px-3 py-1 rounded-full"></span>
              </div>
            </div>
          </div>
          <!-- Tags & Classification -->
          <div class="bg-white rounded-xl border p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="inline-block">🏷️</span> Tags & Classification
            </h3>
            <div class="flex flex-wrap gap-2 mb-6" id="modalEnquiryTags"></div>
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="inline-block">📈</span> Metrics
            </h3>
            <div class="flex flex-col gap-2">
              <div class="flex justify-between">
                <span class="text-gray-500">Processing Time</span>
                <span id="modalEnquiryProcessingTime" class="font-semibold text-gray-900">2.5 hours</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Priority</span>
                <span id="modalEnquiryPriority" class="bg-gray-100 text-xs px-2 py-1 rounded-full">{{support_tickets.criticality}}</span>
              </div>
            </div>
          </div>
        </div>
        <!-- Enquiry Summary -->
        <div class="bg-white rounded-xl border p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="inline-block">💬</span> Inquiry Details
          </h3>
          <div class="flex items-center mb-2">
            <span class="bg-gray-100 text-xs px-2 py-1 rounded-full mr-2" id="modalEnquiryCategory"></span>
          </div>
          <div class="mb-2">
            <span class="font-bold">Description</span>
            <div id="modalEnquirySummary" class="text-gray-800 mt-1"></div>
          </div>
          <div class="mb-2">
            <span class="font-bold">Estimated Value</span><br>
            <span id="modalEnquiryEstimatedValue" class="text-green-600 font-bold text-xl"></span>
          </div>
        </div>
      </div>
      <!-- Details -->
      <div id="enquiry-content-details" class="hidden">
        <h3 class="text-2xl font-bold mb-4">Details</h3>
        <div class="space-y-2">
          <div><span class="font-bold">Criticality:</span> <span id="modalEnquiryCriticality" class="inline-block px-2 py-0.5 rounded-full text-xs"></span></div>
          <div><span class="font-bold">Status:</span> <span id="modalEnquiryStatusDetail"></span></div>
          <div><span class="font-bold">Assigned To:</span> <span id="modalEnquiryAssigned"></span></div>
          <div><span class="font-bold">Created At:</span> <span id="modalEnquiryCreated"></span></div>
          <!-- Add this where you want the JSON button and block to appear in the modal -->
          <div class="mt-4">
            <label class="font-semibold text-gray-800">Raw Postmark JSON:</label>
            <button id="toggleRawJsonBtn" type="button" class="ml-2 px-3 py-1 bg-gray-100 rounded border text-xs">Show Raw Postmark JSON</button>
            <pre id="modalEnquiryRawJsonBlock" class="bg-gray-100 border rounded p-4 text-xs mt-2 hidden" style="max-height:300px;overflow:auto;"></pre>
          </div>
        </div>
        <div class="mt-4">
          <span class="font-bold">Gemini AI Summary from Mail Content:</span>
          <div id="modalEnquiryDetails" class="text-gray-700"></div>
        </div>
      </div>
      <!-- Timeline -->
      <div id="enquiry-content-timeline" class="hidden">
        <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <span class="inline-block">🕒</span> Timeline
        </h3>
        <div id="modalEnquiryTimeline" class="space-y-6"></div>
      </div>
      <!-- Email Actions -->
      <div id="enquiry-content-actions" class="hidden">
        <h3 class="font-bold mb-2">📧 Original Email</h3>
        <div id="modalEnquiryMailContent" class="bg-gray-50 border rounded p-4 text-sm font-mono whitespace-pre-line" style="max-height:300px;overflow:auto;">hello</div>
      </div>
    </div>
  </div>
</div>
    <script>
        // JavaScript for Navigation Bar Filtering
        const tabs = document.querySelectorAll('.nav-card'); // Navigation tabs
        const allCards = document.querySelectorAll('.orderCard, .approvalCard, .customerEnquiryCard'); // Select all cards
    
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
    
                // Remove active class from all tabs and add it to the clicked tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
    
                const tabId = tab.id.replace('-tab', ''); // Extract tab identifier
    
                // Filter cards based on the selected tab
                if (tabId === 'active-workflows') {
                    allCards.forEach(card => card.style.display = 'block'); // Show all cards
                } else if (tabId === 'sales') {
                    allCards.forEach(card => {
                        if (card.classList.contains('orderCard')) {
                            card.style.display = 'block'; // Show order cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'hr-workflows') {
                    allCards.forEach(card => {
                        if (card.classList.contains('approvalCard')) {
                            card.style.display = 'block'; // Show approval cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'approvals') {
                    allCards.forEach(card => {
                        if (card.classList.contains('approvalCard')) {
                            card.style.display = 'block'; // Show approval cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'customer-enquiries') {
                    allCards.forEach(card => {
                card.style.display = card.classList.contains('customerEnquiryCard') ? 'block' : 'none';
            }); // Hide all cards
                }
            });
        });
    </script>
<script>
    const orderCards = document.querySelectorAll('.order-card'); // Select all order cards
    const modal = document.getElementById('order-modal'); // Modal element
    const modalTitle = document.getElementById('order-title'); // Modal title
    const modalContent = document.getElementById('order-content'); // Modal content
    const closeModalButton = document.getElementById('close-modal'); // Close button

    // Function to open the modal
    const openModal = (order) => {
    modalTitle.textContent = `Order #${order.id}`;

    modalContent.innerHTML = `
    <div class="w-[900px] bg-white rounded-xl shadow-2xl overflow-hidden">
      <div class="flex justify-between items-center px-6 py-4 border-b">
        <div>
          <h2 class="text-xl font-semibold">Order #${order.id}</h2>
          <p class="text-sm text-gray-500">Updated ${new Date(new Date().getTime() + 45 * 60000).toLocaleString()}</p>
        </div>
        <div class="flex items-center gap-4">
          <span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">CONFIRMED</span>
          <p class="text-sm text-gray-600">${new Date().toLocaleString()}</p>
        </div>
      </div>

      <div class="flex border-b">
        <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn px-6 py-3 font-semibold text-sm text-black border-b-2 border-black">Overview</button>
        <button onclick="switchTab('details')" id="tab-details" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Details</button>
        <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Timeline</button>
        <button onclick="switchTab('actions')" id="tab-actions" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Email</button>
      </div>

      <div id="tab-content" class="p-6 text-sm text-gray-700 space-y-6">

                <!-- Overview -->
        <div id="content-overview">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Customer Information -->
            <div class="col-span-2 bg-white rounded-xl border p-6">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">👤</span> Customer Information
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-gray-500 text-sm mb-1">Name</div>
                  <div class="font-bold text-lg text-gray-900">${order.customerName}</div>
                  <div class="text-gray-500 text-sm mt-4 mb-1">Email</div>
                  <div class="text-gray-700 text-sm">${order.customerEmail}</div>
                </div>
                <div>
                  <div class="text-gray-500 text-sm mb-1">Company</div>
                  <div class="font-bold text-lg text-gray-900">TechCorp Solutions</div>
                  <div class="text-gray-500 text-sm mt-4 mb-1">Customer Type</div>
                  <span class="bg-gray-200 text-xs px-2 py-1 rounded-full">${order.customerType || 'N/A'}</span>
                </div>
              </div>
            </div>
            <!-- Tags & Classification -->
            <div class="bg-white rounded-xl border p-6">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">🏷️</span> Tags & Classification
              </h3>
              <div class="flex flex-wrap gap-2 mb-6">
                ${(order.tags || ['No Tags']).map(tag => `<span class="bg-gray-100 px-2 py-1 text-xs rounded-full">${tag}</span>`).join('')}
              </div>
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">�</span> Metrics
              </h3>
              <div class="flex flex-col gap-2">
                <div class="flex justify-between">
                  <span class="text-gray-500">Processing Time</span>
                  <span class="font-semibold text-gray-900">${order.processingTime || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">Priority</span>
                  <span class="bg-gray-100 text-xs px-2 py-1 rounded-full">${order.priority || 'N/A'}</span>
                </div>
              </div>
            </div>
          </div>
          <!-- Order Summary -->
          <div class="bg-white rounded-xl border p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="inline-block">$</span> Order Summary
            </h3>
            <div class="flex items-center mb-2">
              <span class="text-2xl font-bold text-gray-900 mr-4">USD ${order.totalValue}</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">${order.items ? order.items.length : order.quantity} items</span>
            </div>
            <div class="bg-blue-50 p-4 mt-2 rounded">
              <h4 class="font-medium text-blue-800 mb-1">AI Summary</h4>
              <p class="text-sm text-blue-900">${order.summary}</p>
            </div>
          </div>
        </div>

                <!-- Details -->
        <div id="content-details" class="hidden">
          <h3 class="text-2xl font-bold mb-4">Order Items</h3>
          <div class="space-y-6">
            ${(order.items || []).map(item => `
              <div class="flex justify-between items-center bg-gray-50 rounded-lg p-6">
                <div>
                  <div class="font-bold text-lg mb-1">${item.name}</div>
                  <div class="text-gray-700 text-sm">Category: ${item.category}</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-xl text-gray-900 mb-1">USD ${item.total.toLocaleString()}</div>
                  <div class="text-gray-500 text-sm">Qty: ${item.quantity} × USD${item.price}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Timeline -->
        <div id="content-timeline" class="hidden">
          <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="inline-block">🕒</span> Timeline
          </h3>
          <div class="space-y-6">
            ${(order.timeline || []).map(event => `
              <div class="flex items-start justify-between bg-white rounded-lg p-4 shadow-sm">
                <div class="flex items-start gap-4">
                  <span class="mt-1 w-4 h-4 rounded-full bg-blue-400 flex-shrink-0"></span>
                  <div>
                    <div class="font-bold text-lg text-gray-900">${event.label}</div>
                    <div class="text-gray-500 text-xs mb-1">${event.time}</div>
                    <div class="text-gray-700 text-sm">${event.details || ''}</div>
                  </div>
                </div>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold self-center">${event.status || 'completed'}</span>
              </div>
            `).join('')}
          </div>
        </div>
        

        <!-- Email Actions -->
        <div id="content-actions" class="hidden">
          <h3 class="font-bold mb-2">📧 Original Email</h3>
            <div class="bg-gray-50 border rounded p-4 text-sm font-mono whitespace-pre-line" style="max-height:300px;overflow:auto;">
          ${order.mailContent ? order.mailContent : '<span class="text-gray-400">No original mail content available.</span>'}
          <h3 class="font-bold mt-4 mb-2">📝 Postmark Inbound JSON</h3>
  <pre class="bg-gray-100 border rounded p-4 text-xs" style="max-height:300px;overflow:auto;">
    ${order.rawJson ? JSON.stringify(JSON.parse(order.rawJson), null, 2) : '<span class="text-gray-400">No JSON available.</span>'}
  </pre>
        </div>
        </div>

      </div>
    </div>
    `;

    modal.classList.remove('hidden');
};


    // Function to close the modal
    const closeModalHandler = () => {
        modal.classList.add('hidden'); // Hide modal
        modalTitle.textContent = ''; // Clear modal title
        modalContent.innerHTML = ''; // Clear modal content
    };

    // Add click event listeners to order cards
    orderCards.forEach((card) => {
        card.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default redirection

            const orderId = card.dataset.orderId;

            const customerInfoElement = card.querySelector('div.mb-4 > p.font-semibold.text-lg.text-gray-800');
            const quantityValue = card.querySelector('p.text-xl.text-gray-800')?.textContent.trim();
            const totalValueAmount = card.querySelector('p.text-green-600')?.textContent.trim().replace('USD ', '');
            const summaryText = card.querySelector('div.mb-4.p-4.bg-blue-50 > p.text-sm.text-gray-700')?.textContent.trim();

            if (!orderId || !customerInfoElement || !quantityValue || !totalValueAmount || !summaryText) {
                console.error('Missing data for modal on card:', card);
                return;
            }

            const tags = Array.from(card.querySelectorAll('.badge-tag')).map(tag => tag.textContent.trim());

const order = {
    id: orderId,
    customerName: customerInfoElement.textContent.trim(),
    customerEmail: customerInfoElement.textContent.trim(),
    totalValue: totalValueAmount,
    quantity: quantityValue,
    summary: summaryText,
    tags: tags.length > 0 ? tags : ['No Tags'],
    processingTime: '2.5 hours',
    mailContent: card.querySelector('.mail-content')?.innerHTML.trim() || '',
    rawJson: card.querySelector('.raw-json')?.textContent.trim() || '',
    priority: 'low',
    customerType: 'existing',
    // items: [
    //     { name: "Premium Enterprise License", quantity: 50, price: 299, total: 14950, category: "Software" },
    //     { name: "Priority Support Package", quantity: 1, price: 500, total: 500, category: "Support" },
    //     { name: "Training Sessions", quantity: 2, price: 150, total: 300, category: "Training" },
    // ],
    items: (() => {
    const itemsDiv = card.querySelector('.order-items');
    if (itemsDiv && itemsDiv.textContent.trim()) {
        try {
            return JSON.parse(itemsDiv.textContent.trim());
        } catch (e) {
            return [];
        }
    }
    return [];
})(),
    timeline: [
        { label: "Credit check completed", time: "Jan 15, 14:32" },
        { label: "Inventory reserved", time: "Jan 15, 14:35" },
        { label: "Invoice generated", time: "Jan 15, 14:40" },
        { label: "Shipping scheduled", time: "Jan 15, 15:00" },
        { label: "Customer notification sent", time: "Jan 15, 15:15" },
    ]
};
        console.log("Mail content for modal:", order.mailContent);


            openModal(order);
        });
    });

    // Add click event listener to close button
    closeModalButton.addEventListener('click', closeModalHandler);

    // Close modal when clicking outside the modal content
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModalHandler();
        }
    });

    function getAutomationProgress(order) {
    // Example logic: adjust according to your backend status fields
    let steps = [
        { label: "Received", done: !!order.received },
        { label: "Processed", done: !!order.processed },
        { label: "Summary Generated", done: !!order.summary }
    ];
    let completed = steps.filter(s => s.done).length;
    let percent = Math.round((completed / steps.length) * 100);
    return { steps, completed, total: steps.length, percent };
    
}
</script>
<script>
    const switchTab = (tabId) => {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('#tab-content > div');
        tabContents.forEach(content => content.classList.add('hidden'));

        // Remove active class from all tab buttons
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => button.classList.remove('border-black', 'text-black'));

        // Show the selected tab content
        const selectedContent = document.getElementById(`content-${tabId}`);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }

        // Add active class to the selected tab button
        const selectedButton = document.getElementById(`tab-${tabId}`);
        if (selectedButton) {
            selectedButton.classList.add('border-black', 'text-black');
        }
    };
</script>

<script>
function switchEnquiryTab(tabId) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('#enquiry-tab-content > div');
    tabContents.forEach(content => content.classList.add('hidden'));

    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(button => button.classList.remove('border-black', 'text-black'));

    // Show the selected tab content
    const selectedContent = document.getElementById(`enquiry-content-${tabId}`);
    if (selectedContent) {
        selectedContent.classList.remove('hidden');
    }

    // Add active class to the selected tab button
    const selectedButton = document.getElementById(`enquiry-tab-${tabId}`);
    if (selectedButton) {
        selectedButton.classList.add('border-black', 'text-black');
    }
}

document.querySelectorAll('.customer-enquiry-card').forEach(card => {
    card.addEventListener('click', function(e) {
        e.preventDefault();
        // Modal Title
        document.getElementById('enquiry-modal-title').textContent = this.dataset.subject || 'Customer Enquiry Details';
        // Status
        document.getElementById('modalEnquiryStatus').textContent = (this.dataset.status || '').toUpperCase();
        // Inquirer Name
        document.getElementById('modalEnquirySender').textContent = this.dataset.sender || '';
        // Email (if available)
        document.getElementById('modalEnquiryEmail').textContent = this.dataset.email || '';
        // Company (extract from subject if possible)
        document.getElementById('modalEnquiryCriticality').textContent = this.dataset.criticality || 'Medium';
        // Color code criticality
        const crit = this.dataset.criticality?.toLowerCase() || 'medium';
        const critEl = document.getElementById('modalEnquiryCriticality');
        critEl.className = 'inline-block px-2 py-0.5 rounded-full text-xs ' +
            (crit === 'urgent' ? 'bg-red-100 text-red-700' :
            crit === 'high' ? 'bg-orange-100 text-orange-700' :
            crit === 'medium' ? 'bg-yellow-100 text-yellow-700' :
            'bg-green-100 text-green-700');
        document.getElementById('modalEnquiryStatusDetail').textContent = this.dataset.status || '';
        document.getElementById('modalEnquiryAssigned').textContent = this.dataset.assigned || 'Unassigned';
        document.getElementById('modalEnquiryCreated').textContent = this.dataset.created || '';
        document.getElementById('modalEnquiryRawJson').textContent = this.dataset.rawjson || '';
        let rawJson = this.dataset.rawjson || '';
        let prettyJson = '';
        try {
            prettyJson = rawJson ? JSON.stringify(JSON.parse(rawJson), null, 2) : '';
        } catch (err) {
            prettyJson = 'Invalid JSON';
        }
        document.getElementById('modalEnquiryRawJsonBlock').textContent = prettyJson;
        document.getElementById('modalEnquiryRawJsonBlock').classList.add('hidden');
        document.getElementById('modalEnquiryRawJsonBlock').textContent = prettyJson;
        document.getElementById('modalEnquiryRawJsonBlock').classList.add('hidden');
        document.getElementById('toggleRawJsonBtn').textContent = 'Show Raw Postmark JSON';
        document.getElementById('toggleRawJsonBtn').onclick = function() {
      const block = document.getElementById('modalEnquiryRawJsonBlock');
      if (block.classList.contains('hidden')) {
          block.classList.remove('hidden');
          this.textContent = 'Hide Raw Postmark JSON';
      } else {
          block.classList.add('hidden');
          this.textContent = 'Show Raw Postmark JSON';
      }
  };
        let company = '';
        const subj = this.dataset.subject || '';
        const match = subj.match(/- (.+)$/);
        if (match) company = match[1];
        document.getElementById('modalEnquiryCompany').textContent = company;
        // Source (static for now)
        document.getElementById('modalEnquirySource').textContent = 'email';
        // Response Time (static or dynamic)
        document.getElementById('modalEnquiryResponseTime').textContent = '2 hours';
        // Tags
        const tagsDiv = document.getElementById('modalEnquiryTags');
        tagsDiv.innerHTML = '';
        if (this.dataset.tags) {
            this.dataset.tags.split(',').forEach(tag => {
                if (tag.trim()) {
                    const span = document.createElement('span');
                    span.className = 'bg-gray-100 px-2 py-1 text-xs rounded-full';
                    span.textContent = tag.trim();
                    tagsDiv.appendChild(span);
                }
            });
        }
        // Metrics
        document.getElementById('modalEnquiryProcessingTime').textContent = '2.5 hours';
        document.getElementById('modalEnquiryPriority').textContent = 'high';
        // Inquiry Details
        document.getElementById('modalEnquiryCategory').textContent = this.dataset.category || '';
        document.getElementById('modalEnquirySummary').textContent = this.dataset.summary || '';
        // Estimated Value (if present)
        document.getElementById('modalEnquiryEstimatedValue').textContent = this.dataset.estimatedValue ? '$' + this.dataset.estimatedValue : '';
        // Details tab
        document.getElementById('modalEnquiryDetails').textContent = this.dataset.summary || '';
        // Timeline tab (dummy for now)
        document.getElementById('modalEnquiryTimeline').innerHTML = `
            <div class="flex items-start justify-between bg-white rounded-lg p-4 shadow-sm">
                <div>
                    <div class="font-bold text-lg text-gray-900">Enquiry Received</div>
                    <div class="text-gray-500 text-xs mb-1">Just now</div>
                    <div class="text-gray-700 text-sm">This enquiry was received and is being processed.</div>
                </div>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold self-center">open</span>
            </div>
        `;
        // Email tab
        let msg = this.dataset.message || '';
        msg = msg.replace(/\n/g, '<br>');
        msg = msg.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, '<span class="text-blue-700 font-semibold">$1</span>');
        document.getElementById('modalEnquiryMailContent').innerHTML = msg;
        document.getElementById('customerEnquiryModal').classList.remove('hidden');
        switchEnquiryTab('overview');
    });
});

document.getElementById('toggleRawJsonBtn').onclick = function() {
    const block = document.getElementById('modalEnquiryRawJsonBlock');
    if (block.classList.contains('hidden')) {
        block.classList.remove('hidden');
        this.textContent = 'Hide Raw Postmark JSON';
    } else {
        block.classList.add('hidden');
        this.textContent = 'Show Raw Postmark JSON';
    }
};
document.getElementById('closeCustomerEnquiryModal').onclick = function() {
    document.getElementById('customerEnquiryModal').classList.add('hidden');
};
window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('customerEnquiryModal').classList.add('hidden');
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Helper to safely set textContent
  const safeSet = (id, val = '') => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  };

  document.querySelectorAll('.customer-enquiry-card').forEach(card => {
    card.addEventListener('click', function (e) {
      e.preventDefault();

      safeSet('enquiry-modal-title', this.dataset.subject || 'Customer Enquiry');
      safeSet('modalEnquiryStatus', (this.dataset.status || '').toUpperCase());
      safeSet('modalEnquirySender', this.dataset.sender || '');
      safeSet('modalEnquiryEmail', this.dataset.email || '');
      safeSet('modalEnquiryStatusDetail', this.dataset.status || '');
      safeSet('modalEnquiryAssigned', this.dataset.assigned || 'Unassigned');
      safeSet('modalEnquiryCreated', this.dataset.created || '');
      safeSet('modalEnquiryCategory', this.dataset.category || '');
      safeSet('modalEnquirySummary', this.dataset.summary || '');
      safeSet('modalEnquiryDetails', this.dataset.summary || '');
      safeSet('modalEnquiryEstimatedValue', this.dataset.estimatedValue ? '$' + this.dataset.estimatedValue : '');
      safeSet('modalEnquiryMailContent', this.dataset.message || '');

      // Criticality with class coloring
      const crit = (this.dataset.criticality || 'Medium').toLowerCase();
      const critEl = document.getElementById('modalEnquiryCriticality');
      if (critEl) {
        critEl.textContent = this.dataset.criticality;
        critEl.className = 'inline-block px-2 py-0.5 rounded-full text-xs ' +
          (crit === 'urgent' ? 'bg-red-100 text-red-700' :
          crit === 'high' ? 'bg-orange-100 text-orange-700' :
          crit === 'medium' ? 'bg-yellow-100 text-yellow-700' :
          'bg-green-100 text-green-700');
      }

      // Company (from subject)
      const match = (this.dataset.subject || '').match(/- (.+)$/);
      safeSet('modalEnquiryCompany', match ? match[1] : '');

      // Static values
      safeSet('modalEnquirySource', 'email');
      safeSet('modalEnquiryResponseTime', '2 hours');
      safeSet('modalEnquiryProcessingTime', '2.5 hours');
      safeSet('modalEnquiryPriority', this.dataset.criticality || 'Medium');

      // Tags rendering
      const tagsDiv = document.getElementById('modalEnquiryTags');
      if (tagsDiv) {
        tagsDiv.innerHTML = '';
        if (this.dataset.tags) {
          this.dataset.tags.split(',').forEach(tag => {
            if (tag.trim()) {
              const span = document.createElement('span');
              span.className = 'bg-gray-100 px-2 py-1 text-xs rounded-full';
              span.textContent = tag.trim();
              tagsDiv.appendChild(span);
            }
          });
        }
      }

      // Raw JSON
      let rawJson = this.dataset.rawjson || '';
      let prettyJson = '';
      try {
        prettyJson = rawJson ? JSON.stringify(JSON.parse(rawJson), null, 2) : '';
      } catch {
        prettyJson = 'Invalid JSON';
      }
      const rawBlock = document.getElementById('modalEnquiryRawJsonBlock');
      if (rawBlock) {
        rawBlock.textContent = prettyJson;
        rawBlock.classList.add('hidden');
      }

      // Toggle button setup
      const toggleBtn = document.getElementById('toggleRawJsonBtn');
      if (toggleBtn) {
        toggleBtn.textContent = 'Show Raw Postmark JSON';
        toggleBtn.onclick = function () {
          if (rawBlock.classList.contains('hidden')) {
            rawBlock.classList.remove('hidden');
            this.textContent = 'Hide Raw Postmark JSON';
          } else {
            rawBlock.classList.add('hidden');
            this.textContent = 'Show Raw Postmark JSON';
          }
        };
      }

      // Timeline dummy block
      const timeline = document.getElementById('modalEnquiryTimeline');
      if (timeline) {
        timeline.innerHTML = `
          <div class="flex items-start justify-between bg-white rounded-lg p-4 shadow-sm">
            <div>
              <div class="font-bold text-lg text-gray-900">Enquiry Received</div>
              <div class="text-gray-500 text-xs mb-1">Just now</div>
              <div class="text-gray-700 text-sm">This enquiry was received and is being processed.</div>
            </div>
            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold self-center">${this.dataset.status}</span>
          </div>
        `;
      }

      // Open modal
      document.getElementById('customerEnquiryModal')?.classList.remove('hidden');
      switchEnquiryTab('overview');
    });
  });

  // Close modal actions
  document.getElementById('closeCustomerEnquiryModal')?.addEventListener('click', () => {
    document.getElementById('customerEnquiryModal')?.classList.add('hidden');
  });

  window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      document.getElementById('customerEnquiryModal')?.classList.add('hidden');
    }
  });
});
</script>
<script>
const approvalCards = document.querySelectorAll('.approval-card');
const approvalModal = document.getElementById('approval-modal');
const approvalTabContent = document.getElementById('approval-tab-content');
const approvalModalTitle = document.getElementById('approval-modal-title');
const closeApprovalModalButton = document.getElementById('closeApprovalModal');

function formatDate(dateStr) {
  if (!dateStr || dateStr === "None") return '—';
  const d = new Date(dateStr);
  return isNaN(d) ? '—' : d.toLocaleDateString();
}

function openApprovalModal(approval) {
  approvalModalTitle.textContent = `${approval.approval_type || 'Approval'} Request${approval.sender ? ' - ' + approval.sender : ''}`;
  // Overview Tab
  const overview = `
    <div id="approval-content-overview">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="col-span-2 bg-white rounded-xl border p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="inline-block">👤</span> Employee Information
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-gray-500 text-sm mb-1">Employee</div>
              <div class="font-bold text-lg text-gray-900">${approval.sender || '—'}</div>
            </div>
            <div>
              <div class="text-gray-500 text-sm mb-1">Status</div>
              <div class="font-bold text-lg text-gray-900">${approval.status || '—'}</div>
              <div class="text-gray-500 text-sm mt-4 mb-1">Created</div>
              <div class="text-gray-700 text-sm">${formatDate(approval.created_at)}</div>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl border p-6">
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="inline-block">🏷️</span> Tags & Classification
          </h3>
          <div class="flex flex-wrap gap-2 mb-6">
            ${(approval.tags || []).map(tag => `<span class="bg-gray-100 px-2 py-1 text-xs rounded-full">${tag}</span>`).join('')}
          </div>
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span class="inline-block">📈</span> Metrics
          </h3>
          <div class="flex flex-col gap-2">
            <div class="flex justify-between">
              <span class="text-gray-500">Processing Time</span>
              <span class="font-semibold text-gray-900">2.5 hours</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Priority</span>
              <span class="bg-gray-100 text-xs px-2 py-1 rounded-full">medium</span>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl border p-6">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span class="inline-block">📝</span> Request Details
        </h3>
        <div class="flex items-center mb-2 font-black">Type: 
          <span class="bg-yellow-100 text-xs px-2 py-1 rounded-full mr-2">${approval.approval_type || '—'}</span>
        </div>
        <div class="mb-2">
          <span class="font-bold">Description</span>
          <div class="text-gray-800 mt-1">${approval.summary || approval.request_text || '—'}</div>
        </div>
        <div class="mb-2">
          <span class="font-bold">Start Date</span><br>
          <span>${formatDate(approval.start_date)}</span>
        </div>
        <div class="mb-2">
          <span class="font-bold">End Date</span><br>
          <span>${formatDate(approval.end_date)}</span>
        </div>
      </div>
    </div>
  `;
  // Details Tab
  const details = `
    <div id="approval-content-details" class="hidden">
      <h3 class="font-semibold text-gray-800 text-base mb-2">Approval Details - Original Mail</h3>
      <pre style="font-size:1rem!important;" class="bg-gray-100 border rounded p-4 text-xs">${approval.request_text || ''}</pre>
    </div>
  `;
  const timeline = `
    <div id="approval-content-timeline" class="hidden">
      <h3 class="font-semibold text-gray-800 text-base mb-2">Timeline</h3>
      <ul>
        <li>Request Submitted: ${formatDate(approval.created_at)}</li>
        <li>Status: ${approval.status}</li>
      </ul>
    </div>
  `;
  const actions = `
    <div id="approval-content-actions" class="hidden">
      <h3 class="font-semibold text-xl text-gray-800">Actions</h3>
      <div style="display:flex; flex-direction:column;justify-content:space-between;align-items:center;margin-top:1rem;">
        <h3 class="text-sm font-bold mb-4">Approve or Reject leave of ${approval.sender}</h3>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-info-icon lucide-badge-info"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
        <div class="text-sm text-gray-500 mb-4">Accepting or rejecting will update status and send Outbound Email to sender.</div>
      </div>
      <form method="post" action="/approvals/${approval.id}/approve" style="display:inline;">
        <button class="button bg-green-600 text-white px-4 py-2 rounded" type="submit">Approve</button>
      </form>
      <form method="post" action="/approvals/${approval.id}/reject" style="display:inline;">
        <button class="button bg-red-600 text-white px-4 py-2 rounded ml-2" type="submit">Reject</button>
      </form>
    </div>
  `;
  approvalTabContent.innerHTML = overview + details + timeline + actions;
  switchApprovalTab('overview');
  approvalModal.classList.remove('hidden');
}

function switchApprovalTab(tabId) {
  ['overview', 'details', 'timeline', 'actions'].forEach(t => {
    const el = document.getElementById(`approval-content-${t}`);
    const btn = document.getElementById(`approval-tab-${t}`);
    if (el) el.classList.add('hidden');
    if (btn) btn.classList.remove('border-black', 'text-black');
  });
  const selectedContent = document.getElementById(`approval-content-${tabId}`);
  const selectedButton = document.getElementById(`approval-tab-${tabId}`);
  if (selectedContent) selectedContent.classList.remove('hidden');
  if (selectedButton) selectedButton.classList.add('border-black', 'text-black');
}

approvalCards.forEach(card => {
  card.addEventListener('click', (e) => {
    e.preventDefault();
    const approval = {
      id: card.getAttribute('data-id'),
      approval_type: card.getAttribute('data-type'),
      sender: card.getAttribute('data-sender'),
      summary: card.getAttribute('data-summary'),
      status: card.getAttribute('data-status'),
      created_at: card.getAttribute('data-created'),
      request_text: card.getAttribute('data-request'),
      start_date: card.getAttribute('data-start'),
      end_date: card.getAttribute('data-end'),
      tags: card.getAttribute('data-tags') ? card.getAttribute('data-tags').split(',') : []
    };
    openApprovalModal(approval);
  });
});

closeApprovalModalButton.addEventListener('click', () => {
  approvalModal.classList.add('hidden');
});
approvalModal.addEventListener('click', (e) => {
  if (e.target === approvalModal) approvalModal.classList.add('hidden');
});
</script>

{% endblock %}