{% extends "layout.html" %} 

{% block title %}
Dashboard - InboxOps
{% endblock %}

{% block content %}
<link rel="stylesheet" href="../static/styles.css">

<section style="margin-bottom: 0;" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
    <div class="card bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm">
    <h3 class="text-lg font-semibold text-blue-600">Total Processed</h3>
    <p class="text-3xl font-bold text-blue-800">{{ total_processed }}</p>
    <p class="text-sm text-blue-500">+{{ processed_today }} today</p>
    <div class="mt-2">
        <p class="text-xs text-blue-400">Processed Emails: {{ total_processed }}%</p>
        <div class="w-full bg-blue-200 rounded-full h-2.5">
            <div class="bg-blue-600 h-2.5 rounded-full" data-processing-rate="{{ processing_rate|default(0) }}"></div>
        </div>
    </div>
    </div>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-green-600">Success Rate</h3>
        <p class="text-3xl font-bold text-green-800">{{ success_rate }}%</p>
        <p class="text-sm text-green-500">‚Üë {{ success_rate_change }}% from last week</p>
        <p class="text-xs text-green-400">Avg. Processing Time: {{ avg_processing_time }}s</p>
    </div>

    <div class="card bg-orange-50 border border-orange-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-orange-600">Active Webhooks</h3>
        <p class="text-3xl font-bold text-orange-800">{{ active_webhooks }}</p>
        <p class="text-sm text-orange-500">{{ webhook_endpoints }} endpoints configured</p>
        <p class="text-xs text-orange-400">Avg. Latency: {{ avg_latency }}ms</p>
    </div>

    <div class="card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-purple-600">Pending Approvals</h3>
        <p class="text-3xl font-bold text-purple-800">{{ approvals|length }}</p>
        <p class="text-sm text-purple-500">Last Approval: {{ approvals[0].created_at.strftime('%b %d, %I:%M %p') if approvals }}</p>
    </div>

    <div class="card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-green-600">Orders</h3>
        <p class="text-3xl font-bold text-green-800">{{ orders|length }}</p>
        <p class="text-sm text-green-500">Last Order: {{ orders[0].created_at.strftime('%b %d, %I:%M %p') if orders }}</p>
    </div>

    <div class="card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-purple-600">Classifications</h3>
        <p class="text-3xl font-bold text-purple-800">{{ active_models }}</p>
        <p class="text-sm text-purple-500">Top Type: {{ top_classification_type }} ({{ top_classification_percentage }}%)</p>
    </div>
    <div class="card bg-red-50 border border-red-200 rounded-lg p-4 shadow-sm">
        <h3 class="text-lg font-semibold text-red-600">Error Rate</h3>
        <p class="text-3xl font-bold text-red-800">{{ error_rate }}%</p>
        <p class="text-sm text-red-500">‚Üì {{ error_rate_change }}% from yesterday</p>
        <p class="text-xs text-red-400">Last Error: {{ last_error_time }}</p>
    </div>
</section>

<section class="bg-gray-100 shadow-md rounded-lg p-6 mb-6">
    <nav class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
        <a href="#" id="active-workflows-tab" class="nav-card bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-blue-100 active:bg-blue-200">
            <h3 class="text-lg font-semibold text-blue-600">Active Workflows</h3>
            <p class="text-sm text-gray-500">View all workflows</p>
        </a>
        <a href="#" id="sales-tab" class="nav-card bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-green-100 active:bg-green-200">
            <h3 class="text-lg font-semibold text-green-600">Sales</h3>
            <p class="text-sm text-gray-500">View orders</p>
        </a>
        <a href="#" id="hr-workflows-tab" class="nav-card bg-purple-50 border border-purple-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-purple-100 active:bg-purple-200">
            <h3 class="text-lg font-semibold text-purple-600">HR Workflows</h3>
            <p class="text-sm text-gray-500">View approvals</p>
        </a>
        <a href="#" id="approvals-tab" class="nav-card bg-orange-50 border border-orange-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-orange-100 active:bg-orange-200">
            <h3 class="text-lg font-semibold text-orange-600">Pending Approvals</h3>
            <p class="text-sm text-gray-500">View pending tasks</p>
        </a>
        <a href="#" id="customer-enquiries-tab" class="nav-card bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm transition duration-300 hover:bg-gray-100 active:bg-gray-200">
            <h3 class="text-lg font-semibold text-gray-600">Customer Enquiries</h3>
            <p class="text-sm text-gray-500">Coming soon</p>
        </a>
    </nav>
</section>

<section class="mb-8 orderCard">
    <h2 class="text-xl font-semibold mb-3">Orders</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for order in orders %}
        <a href="#" class="order-card border rounded-lg p-4 shadow-sm bg-white transform transition-transform duration-200 hover:scale-105" data-order-id="{{ order.id }}">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M9 21V3m0 0L3 10m6-7l6 7" />
                    </svg>
                    <span class="font-black text-gray-700">#{{ order.id }}</span>
                    <span class="ml-2 text-xs text-gray-500 bg-gray-100 px-2 py-0.5 font-black rounded">Key: {{ order.key }}</span>
                </div>
                <span class="badge badge-confirmed">Confirmed</span>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-500">Customer</p>
                <p class="font-semibold text-lg text-gray-800">
                    {% for email in emails %}
                        {% if email.type == 'ORDER' and email.key == order.key %}
                            {{ email.from_email }}
                        {% endif %}
                    {% endfor %}
                </p>
            </div>

            <div class="mb-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Quantity</p>
                    <p class="font-semibold text-xl text-gray-800">{{ order.quantity }}</p>
                </div>

                <div>
                    <p class="text-sm text-gray-500">Total Value</p>
                    <p class="font-semibold text-green-600">USD {{ order.total_value }}</p>
                </div>
            </div>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg shadow-sm">
                <h3 class="text-sm font-semibold text-blue-600 mb-1">AI Summary</h3>
                <p class="text-sm text-gray-700">{{ order.summary }}</p>
            </div>

            <!-- ...existing code... -->
            <div class="mb-4">
              <p class="text-sm text-gray-500">Automation Progress</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-600 h-2.5 rounded-full"
                     style="width: '{{ order.automation_percent|default(0)|int }}%';">
                </div>
              </div>
              <div class="flex justify-between mt-1 text-xs text-gray-500">
                <span>{{ order.automation_completed if order.automation_completed is defined else 0 }}/3 steps</span>
                <span>%</span>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm text-gray-500">
                <div class="flex items-center gap-2">
                    <svg width="5%" height="5%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 10H3M16 2V6M8 2V6M7.8 22H16.2C17.8802 22 18.7202 22 19.362 21.673C19.9265 21.3854 20.3854 20.9265 20.673 20.362C21 19.7202 21 18.8802 21 17.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V17.2C3 18.8802 3 19.7202 3.32698 20.362C3.6146 20.9265 4.07354 21.3854 4.63803 21.673C5.27976 22 6.11984 22 7.8 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="font-black">
                        {{ order.created_at.strftime('%b %d, %I:%M %p') if order.created_at }}
                    </span>
                </div>
                <div class="flex gap-2">
                    {% for tag in order.tags or [] %}
                    <span class="badge badge-tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="order-items" style="display:none;">{{ order.order_items | tojson | safe }}</div>
            <div class="mail-content" style="display:none;">{{ order.mail_content|safe }}</div>
            <div class="raw-json" style="display:none;">{{ order.raw_json | tojson | safe }}</div>
        </a>
        {% endfor %}
    </div>
</section>

<div id="order-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl max-h-[89vh] h-auto p-6" style="height:auto;max-height:89vh;">
        <div class="flex justify-between items-center mb-4">
            <h2 id="order-title" class="text-2xl font-bold text-gray-800">Order Details</h2>
            {% for order in orders %}
            <span class="ml-2 text-sm text-gray-500 bg-gray-100 px-2 py-0.5 font-black rounded">{{ order.key }}</span>
            <!-- {% endfor %} -->
            <button id="close-modal" class="text-gray-500 hover:text-gray-800 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="order-content" class="space-y-6 text-sm text-gray-700 overflow-y-auto" style="max-height:70vh;">
  <div class="flex justify-between items-center">
    <span class="text-lg font-semibold text-gray-800">Order #<span id="order-id">TC-XXXX-001</span></span>
    <div class="flex flex-col items-end text-xs text-right">
      <span class="inline-block bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">CONFIRMED</span>
      <span class="mt-1 text-gray-500">Mon, Jan 15, 2024, 08:00 PM</span>
      <span class="text-gray-400 text-xs">Updated Mon, Jan 15, 2024, 08:45 PM</span>
    </div>
  </div>

  <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Customer Information -->
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">üë§ Customer Information</h3>
      <p><strong>Name:</strong> <span id="customer-name" class="text-gray-800"></span></p>
      <p><strong>Company:</strong> TechCorp Solutions</p>
      <p><strong>Email:</strong> <span id="customer-email" class="text-gray-800"></span></p>
      <p><strong>Customer Type:</strong> <span class="bg-gray-200 text-xs px-2 py-0.5 rounded-full">existing</span></p>
    </div>

    <!-- Tags & Classification -->
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">üè∑Ô∏è Tags & Classification</h3>
      <div class="flex flex-wrap gap-2">
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">enterprise</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">high-value</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">existing-customer</span>
        <span class="bg-gray-100 px-2 py-1 text-xs rounded-full">express-shipping</span>
      </div>
    </div>
  </div>

  <!-- Order Summary -->
  <div class="border-t pt-4">
    <h3 class="font-semibold text-gray-800 text-base mb-2">üí≤ Order Summary</h3>
    <p class="text-xl text-gray-900 font-bold mb-2">USD <span id="order-value"></span></p>
    <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">3 items</span>
    <div class="mt-3 bg-blue-50 p-3 rounded-md">
      <h4 class="font-medium text-blue-800 mb-1">AI Summary</h4>
      <p id="order-summary" class="text-sm text-blue-900"></p>
    </div>
  </div>

  <!-- Metrics -->
  <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h3 class="font-semibold text-gray-800 text-base mb-2">üìà Metrics</h3>
      <p><strong>Processing Time:</strong> 2.5 hours</p>
      <p><strong>Priority:</strong> low</p>
    </div>
  </div>
</div>

    </div>
</div>
<section class="approvalCard">
    <h2 class="font-semibold mb-3">HR Workflows</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for approval in approvals %}
        <a href="/approvals/{{ approval.id }}" class="approval-card border rounded-lg p-4 shadow-sm bg-white transform transition-transform duration-200 hover:scale-105">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h11M9 21V3m0 0L3 10m6-7l6 7" />
                    </svg>
                    <span class="font-black text-gray-700">{{ approval.approval_type }}</span>
                </div>
                <span class="badge badge-under-review">Under Review</span>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-500">Employee</p>
                <p class="font-semibold text-lg text-gray-800">{{ approval.sender }}</p>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-500">Request Type</p>
                <p class="font-semibold text-lg text-gray-800">{{ approval.approval_type }}</p>
            </div>

            <div class="mb-4 p-4 bg-purple-50 rounded-lg shadow-sm">
                <h3 class="text-sm font-semibold text-purple-600 mb-1">Description</h3>
                <p class="text-sm text-gray-700">{{ approval.request_text }}</p>
            </div>

                        <div class="mb-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Start</p>
                    <p class="font-semibold text-lg text-gray-800">
                        {{ approval.start_date.strftime('%Y-%m-%d') if approval.start_date }}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">End</p>
                    <p class="font-semibold text-lg text-gray-800">
                        {{ approval.end_date.strftime('%Y-%m-%d') if approval.end_date }}
                    </p>
                </div>
            </div>

            <div class="flex items-center justify-between text-sm text-gray-500">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 4h10M5 21h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="font-black">
                        SLA: {{ approval.created_at.strftime('%b %d, %I:%M %p') }}
                    </span>
                </div>
                <div class="flex gap-2">
                    <span class="badge badge-tag">{{ approval.approval_type }}</span>
                    <span class="badge badge-tag">HR</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</section>
    <script>
        // JavaScript for Navigation Bar Filtering
        const tabs = document.querySelectorAll('.nav-card'); // Navigation tabs
        const allCards = document.querySelectorAll('.orderCard, .approvalCard'); // Select all cards
    
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
    
                // Remove active class from all tabs and add it to the clicked tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
    
                const tabId = tab.id.replace('-tab', ''); // Extract tab identifier
    
                // Filter cards based on the selected tab
                if (tabId === 'active-workflows') {
                    allCards.forEach(card => card.style.display = 'block'); // Show all cards
                } else if (tabId === 'sales') {
                    allCards.forEach(card => {
                        if (card.classList.contains('orderCard')) {
                            card.style.display = 'block'; // Show order cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'hr-workflows') {
                    allCards.forEach(card => {
                        if (card.classList.contains('approvalCard')) {
                            card.style.display = 'block'; // Show approval cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'approvals') {
                    allCards.forEach(card => {
                        if (card.classList.contains('approvalCard')) {
                            card.style.display = 'block'; // Show approval cards
                        } else {
                            card.style.display = 'none'; // Hide other cards
                        }
                    });
                } else if (tabId === 'customer-enquiries') {
                    allCards.forEach(card => card.style.display = 'none'); // Hide all cards
                }
            });
        });
    </script>
<script>
    const orderCards = document.querySelectorAll('.order-card'); // Select all order cards
    const modal = document.getElementById('order-modal'); // Modal element
    const modalTitle = document.getElementById('order-title'); // Modal title
    const modalContent = document.getElementById('order-content'); // Modal content
    const closeModalButton = document.getElementById('close-modal'); // Close button

    // Function to open the modal
    const openModal = (order) => {
    modalTitle.textContent = `Order #${order.id}`;

    modalContent.innerHTML = `
    <div class="w-[900px] bg-white rounded-xl shadow-2xl overflow-hidden">
      <div class="flex justify-between items-center px-6 py-4 border-b">
        <div>
          <h2 class="text-xl font-semibold">Order #${order.id}</h2>
          <p class="text-sm text-gray-500">Updated ${new Date(new Date().getTime() + 45 * 60000).toLocaleString()}</p>
        </div>
        <div class="flex items-center gap-4">
          <span class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full">CONFIRMED</span>
          <p class="text-sm text-gray-600">${new Date().toLocaleString()}</p>
        </div>
      </div>

      <div class="flex border-b">
        <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn px-6 py-3 font-semibold text-sm text-black border-b-2 border-black">Overview</button>
        <button onclick="switchTab('details')" id="tab-details" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Details</button>
        <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Timeline</button>
        <button onclick="switchTab('actions')" id="tab-actions" class="tab-btn px-6 py-3 font-semibold text-sm text-gray-500 text-black border-b-2 border-black">Email</button>
      </div>

      <div id="tab-content" class="p-6 text-sm text-gray-700 space-y-6">

                <!-- Overview -->
        <div id="content-overview">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Customer Information -->
            <div class="col-span-2 bg-white rounded-xl border p-6">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">üë§</span> Customer Information
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-gray-500 text-sm mb-1">Name</div>
                  <div class="font-bold text-lg text-gray-900">${order.customerName}</div>
                  <div class="text-gray-500 text-sm mt-4 mb-1">Email</div>
                  <div class="text-gray-700 text-sm">${order.customerEmail}</div>
                </div>
                <div>
                  <div class="text-gray-500 text-sm mb-1">Company</div>
                  <div class="font-bold text-lg text-gray-900">TechCorp Solutions</div>
                  <div class="text-gray-500 text-sm mt-4 mb-1">Customer Type</div>
                  <span class="bg-gray-200 text-xs px-2 py-1 rounded-full">${order.customerType || 'N/A'}</span>
                </div>
              </div>
            </div>
            <!-- Tags & Classification -->
            <div class="bg-white rounded-xl border p-6">
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">üè∑Ô∏è</span> Tags & Classification
              </h3>
              <div class="flex flex-wrap gap-2 mb-6">
                ${(order.tags || ['No Tags']).map(tag => `<span class="bg-gray-100 px-2 py-1 text-xs rounded-full">${tag}</span>`).join('')}
              </div>
              <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="inline-block">ÔøΩ</span> Metrics
              </h3>
              <div class="flex flex-col gap-2">
                <div class="flex justify-between">
                  <span class="text-gray-500">Processing Time</span>
                  <span class="font-semibold text-gray-900">${order.processingTime || 'N/A'}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">Priority</span>
                  <span class="bg-gray-100 text-xs px-2 py-1 rounded-full">${order.priority || 'N/A'}</span>
                </div>
              </div>
            </div>
          </div>
          <!-- Order Summary -->
          <div class="bg-white rounded-xl border p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span class="inline-block">$</span> Order Summary
            </h3>
            <div class="flex items-center mb-2">
              <span class="text-2xl font-bold text-gray-900 mr-4">USD ${order.totalValue}</span>
              <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">${order.items ? order.items.length : order.quantity} items</span>
            </div>
            <div class="bg-blue-50 p-4 mt-2 rounded">
              <h4 class="font-medium text-blue-800 mb-1">AI Summary</h4>
              <p class="text-sm text-blue-900">${order.summary}</p>
            </div>
          </div>
        </div>

                <!-- Details -->
        <div id="content-details" class="hidden">
          <h3 class="text-2xl font-bold mb-4">Order Items</h3>
          <div class="space-y-6">
            ${(order.items || []).map(item => `
              <div class="flex justify-between items-center bg-gray-50 rounded-lg p-6">
                <div>
                  <div class="font-bold text-lg mb-1">${item.name}</div>
                  <div class="text-gray-700 text-sm">Category: ${item.category}</div>
                </div>
                <div class="text-right">
                  <div class="font-bold text-xl text-gray-900 mb-1">USD ${item.total.toLocaleString()}</div>
                  <div class="text-gray-500 text-sm">Qty: ${item.quantity} √ó USD${item.price}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Timeline -->
        <div id="content-timeline" class="hidden">
          <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="inline-block">üïí</span> Timeline
          </h3>
          <div class="space-y-6">
            ${(order.timeline || []).map(event => `
              <div class="flex items-start justify-between bg-white rounded-lg p-4 shadow-sm">
                <div class="flex items-start gap-4">
                  <span class="mt-1 w-4 h-4 rounded-full bg-blue-400 flex-shrink-0"></span>
                  <div>
                    <div class="font-bold text-lg text-gray-900">${event.label}</div>
                    <div class="text-gray-500 text-xs mb-1">${event.time}</div>
                    <div class="text-gray-700 text-sm">${event.details || ''}</div>
                  </div>
                </div>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold self-center">${event.status || 'completed'}</span>
              </div>
            `).join('')}
          </div>
        </div>
        

        <!-- Email Actions -->
        <div id="content-actions" class="hidden">
          <h3 class="font-bold mb-2">üìß Original Email</h3>
            <div class="bg-gray-50 border rounded p-4 text-sm font-mono whitespace-pre-line" style="max-height:300px;overflow:auto;">
          ${order.mailContent ? order.mailContent : '<span class="text-gray-400">No original mail content available.</span>'}
          <h3 class="font-bold mt-4 mb-2">üìù Postmark Inbound JSON</h3>
  <pre class="bg-gray-100 border rounded p-4 text-xs" style="max-height:300px;overflow:auto;">
    ${order.rawJson ? JSON.stringify(JSON.parse(order.rawJson), null, 2) : '<span class="text-gray-400">No JSON available.</span>'}
  </pre>
        </div>
        </div>

      </div>
    </div>
    `;

    modal.classList.remove('hidden');
};


    // Function to close the modal
    const closeModalHandler = () => {
        modal.classList.add('hidden'); // Hide modal
        modalTitle.textContent = ''; // Clear modal title
        modalContent.innerHTML = ''; // Clear modal content
    };

    // Add click event listeners to order cards
    orderCards.forEach((card) => {
        card.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default redirection

            const orderId = card.dataset.orderId;

            const customerInfoElement = card.querySelector('div.mb-4 > p.font-semibold.text-lg.text-gray-800');
            const quantityValue = card.querySelector('p.text-xl.text-gray-800')?.textContent.trim();
            const totalValueAmount = card.querySelector('p.text-green-600')?.textContent.trim().replace('USD ', '');
            const summaryText = card.querySelector('div.mb-4.p-4.bg-blue-50 > p.text-sm.text-gray-700')?.textContent.trim();

            if (!orderId || !customerInfoElement || !quantityValue || !totalValueAmount || !summaryText) {
                console.error('Missing data for modal on card:', card);
                return;
            }

            const tags = Array.from(card.querySelectorAll('.badge-tag')).map(tag => tag.textContent.trim());

const order = {
    id: orderId,
    customerName: customerInfoElement.textContent.trim(),
    customerEmail: customerInfoElement.textContent.trim(),
    totalValue: totalValueAmount,
    quantity: quantityValue,
    summary: summaryText,
    tags: tags.length > 0 ? tags : ['No Tags'],
    processingTime: '2.5 hours',
    mailContent: card.querySelector('.mail-content')?.innerHTML.trim() || '',
    rawJson: card.querySelector('.raw-json')?.textContent.trim() || '',
    priority: 'low',
    customerType: 'existing',
    // items: [
    //     { name: "Premium Enterprise License", quantity: 50, price: 299, total: 14950, category: "Software" },
    //     { name: "Priority Support Package", quantity: 1, price: 500, total: 500, category: "Support" },
    //     { name: "Training Sessions", quantity: 2, price: 150, total: 300, category: "Training" },
    // ],
    items: (() => {
    const itemsDiv = card.querySelector('.order-items');
    if (itemsDiv && itemsDiv.textContent.trim()) {
        try {
            return JSON.parse(itemsDiv.textContent.trim());
        } catch (e) {
            return [];
        }
    }
    return [];
})(),
    timeline: [
        { label: "Credit check completed", time: "Jan 15, 14:32" },
        { label: "Inventory reserved", time: "Jan 15, 14:35" },
        { label: "Invoice generated", time: "Jan 15, 14:40" },
        { label: "Shipping scheduled", time: "Jan 15, 15:00" },
        { label: "Customer notification sent", time: "Jan 15, 15:15" },
    ]
};
        console.log("Mail content for modal:", order.mailContent);


            openModal(order);
        });
    });

    // Add click event listener to close button
    closeModalButton.addEventListener('click', closeModalHandler);

    // Close modal when clicking outside the modal content
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModalHandler();
        }
    });

    function getAutomationProgress(order) {
    // Example logic: adjust according to your backend status fields
    let steps = [
        { label: "Received", done: !!order.received },
        { label: "Processed", done: !!order.processed },
        { label: "Summary Generated", done: !!order.summary }
    ];
    let completed = steps.filter(s => s.done).length;
    let percent = Math.round((completed / steps.length) * 100);
    return { steps, completed, total: steps.length, percent };
    
}
</script>
<script>
    const switchTab = (tabId) => {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('#tab-content > div');
        tabContents.forEach(content => content.classList.add('hidden'));

        // Remove active class from all tab buttons
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => button.classList.remove('border-black', 'text-black'));

        // Show the selected tab content
        const selectedContent = document.getElementById(`content-${tabId}`);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }

        // Add active class to the selected tab button
        const selectedButton = document.getElementById(`tab-${tabId}`);
        if (selectedButton) {
            selectedButton.classList.add('border-black', 'text-black');
        }
    };
</script>
{% endblock %}